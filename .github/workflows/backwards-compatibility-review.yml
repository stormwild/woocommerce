name: Backwards Compatibility PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

concurrency:
  group: bc-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review-with-tracking:
    if: |
      github.event.pull_request.draft == false &&
      github.event.pull_request.head.repo != null &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: PR Review with Progress Tracking (inline-only)
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            WooCommerce/WordPress Backwards Compatibility

            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}

            OBJECTIVE
            Identify ONLY backwards compatibility risks and missing deprecations across PHP, JS/Blocks, REST, templates, and data contracts.

            OUTPUT RULES
            - At most ONE inline comment per (file, original_line, topic). Merge points into a single comment.
            - Insert a hidden marker in every inline comment to enable reliable dedup across pushes:
              <!-- wc-bc:path={path};ol={original_line};topic={topic} -->
            - Before creating a comment, list existing PR review comments and search by this marker. If a matching comment exists, UPDATE it via PATCH to merge new details; do not post a new one.
            - If the marker cannot be constructed (e.g., missing original_line), fallback to (file, line, topic) matching.

            INLINE COMMENT TEMPLATE (use exactly with blank lines between sections)
            ```
            Backwards Compatibility Review

            **Why breaking:** <1-3 sentences>

            **Migration:** <specific code or steps>

            **Deprecation:** <version plan, shim, notices>
            ```
            <!-- wc-bc:path={path};ol={original_line};topic={topic} -->

            ANALYSIS BOUNDARIES
            Include:
              - PHP: public/protected signature or visibility changes; default param changes; return/param type-hints; adding `declare(strict_types=1)` to existing files; thrown exception class changes; removed/renamed hooks (`do_action`, `apply_filters`); `templates/**` contract changes; REST route/param/response changes; DB/schema/options; globals/constants; composer constraints.
              - JS/Blocks: block names/attributes; script/style handle names, dependencies, and load order; `wp.data` selectors/actions; REST schemas; settings/option keys.
            Exclude:
              - `vendor/**`, `node_modules/**`, `build/**`, `dist/**`, `**/*.min.*`, `**/*.map`, translations `**/*.po` `**/*.mo`, images/binaries, generated artifacts, `tests/**`.

            METHOD
            - Cite exact `file:line` for every claim (from the PR diff and repository state).
            - For each risky change propose: non-breaking approach, shim, and staged deprecation timeline.
            - Do not duplicate an existing equivalent "[Backwards Compatibility]" inline comment on the same line/context.
            - For each potential comment determine variables:
              - PATH: the file path of the change
              - LINE: the target line number in the current diff
              - ORIGINAL_LINE: the stable original line if available; otherwise use LINE
              - TOPIC: one of the predefined Topic values
            - Query existing review comments and find a match using the hidden marker first, with path and topic, preferring `original_line` and falling back to `line`:
              gh api "repos/${REPO}/pulls/${PR}/comments?per_page=100" --paginate \
                --jq \
                "map(select(.path==\"${PATH}\" and ((.original_line==${ORIGINAL_LINE}) or (.line==${LINE})) and (.body|contains(\"wc-bc:path=${PATH};\") and (.body|contains(\"topic=${TOPIC}\")) ))) | first | .id"
            - If an ID is returned, PATCH that comment to merge/append updated guidance instead of posting a new one:
              gh api repos/${REPO}/pulls/comments/${ID} -X PATCH -f body@updated_body.md
            - Otherwise, post a single merged comment for that (file, original_line, topic).

          claude_args: >
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api:*),Bash(git show:*),Bash(git diff:*),Bash(git ls-files:*),Bash(git grep:*)"
