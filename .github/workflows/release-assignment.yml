name: 'Release: Assignment'
on:
  schedule:
    - cron: '0 18 * * *' # Every day at 18h UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: read

jobs:
  check-upcoming-release-events:
    name: Check for upcoming release events
    runs-on: ${{ ( github.repository == 'woocommerce/woocommerce' && 'blacksmith-2vcpu-ubuntu-2404' ) || 'ubuntu-latest' }}
    outputs:
      should-trigger-webhook: ${{ steps.check-code-freeze-8-weeks.outputs.should-trigger-webhook }}
      version: ${{ steps.check-code-freeze-8-weeks.outputs.version }}
      feature-freeze-date: ${{ steps.check-code-freeze-8-weeks.outputs.feature-freeze-date }}
      beta-1-release-date: ${{ steps.get-all-events-for-version.outputs.event-beta-1-date }}
      beta-2-release-date: ${{ steps.get-all-events-for-version.outputs.event-beta-2-date }}
      rc-1-release-date: ${{ steps.get-all-events-for-version.outputs.event-rc-1-date }}
      final-release-date: ${{ steps.get-all-events-for-version.outputs.event-final-date }}
      team-name: ${{ steps.get-all-events-for-version.outputs.team-name }}
    steps:
      - name: Install node-ical
        run: npm install node-ical@0.23.1 rrule-temporal@1.4.1
      - name: Check for feature freeze events
        id: check-code-freeze-8-weeks
        uses: actions/github-script@v7
        with:
          script: |
            const ical = require( 'node-ical' );

            const isManualTrigger = context.eventName === 'workflow_dispatch';
            console.log( `Workflow triggered by: ${ context.eventName }` );

            try {
              const today = new Date();
              let targetDate = new Date( today );
              targetDate.setDate( today.getDate() + ( 8 * 7 ) ); // 8 weeks = 56 days.

              const events = await ical.async.fromURL( `https://calendar.google.com/calendar/ical/${{ secrets.RELEASE_CALENDAR_ID }}/public/basic.ics` );
              const codeFreezeEvents = Object.values( events )
                .filter( ( event ) => event.type === 'VEVENT' )
                .filter( ( event ) => {
                  if ( ! event.start ) return false;
                  const pattern = /^WooCommerce \d+\.\d+ Feature Freeze$/i;
                  return pattern.test( event.summary || '' );
                } );

              const eventsInRange = codeFreezeEvents.filter( ( event ) => {
                const eventDate = new Date( event.start );
                const diffTime = Math.abs( eventDate - targetDate );
                const diffDays = Math.ceil( diffTime / ( 1000 * 60 * 60 * 24 ) );

                if ( isManualTrigger ) {
                  // For manual triggers, include events within 2 weeks of the target date.
                  return diffDays <= 14;
                } else {
                  // For scheduled triggers, include events within 1 day of 8 weeks.
                  return diffDays <= 1;
                }
              } );

              if ( eventsInRange.length > 0 ) {
                const date = eventsInRange[ 0 ].start.toISOString();
                const version = eventsInRange[ 0 ].summary.match( /\d+\.\d+/ )[ 0 ];
                console.log( `Found Feature Freeze event: ${ eventsInRange[ 0 ].summary }` );
                console.log( `Date: ${ date }` );
                console.log( `Version: ${ version }` );
                core.setOutput( 'should-trigger-webhook', 'true' );
                core.setOutput( 'version', version );
                core.setOutput( 'feature-freeze-date', date );
              } else {
                console.log( 'No Feature Freeze events found in the specified range.' );
                core.setOutput( 'should-trigger-webhook', 'false' );
              }
            } catch ( error ) {
              core.setFailed( `Failed to fetch calendar events: ${ error.message }` );
            }

      - name: Get all events for version
        if: ${{ steps.check-code-freeze-8-weeks.outputs.version != '' }}
        id: get-all-events-for-version
        uses: actions/github-script@v7
        with:
          script: |
            const ical = require( 'node-ical' );
            const version = '${{ steps.check-code-freeze-8-weeks.outputs.version }}';

            const releaseEvents = {
              'beta-1': `WooCommerce ${ version } Beta 1`,
              'beta-2': `WooCommerce ${ version } Beta 2`,
              'rc-1': `WooCommerce ${ version } RC 1`,
              final: `WooCommerce ${ version } Release`
            };

            const events = await ical.async.fromURL(
              `https://calendar.google.com/calendar/ical/${{ secrets.RELEASE_CALENDAR_ID }}/public/basic.ics`
            );

            const calendarEvents = Object.values( events )
              .filter( ( event ) => event.type === 'VEVENT' )
              .filter( ( event ) => event.summary && event.start );

            let teamName = null;

            for ( const [ eventKey, eventTitle ] of Object.entries( releaseEvents ) ) {
              const matchingEvent = calendarEvents.find( ( event ) =>
                event.summary.trim() === eventTitle
              );

              const date = matchingEvent ? new Date( matchingEvent.start ).toISOString().split( 'T' )[ 0 ] : null;
              core.setOutput( `event-${ eventKey }-date`, date );
              console.log( `Event: ${ eventTitle }, Date: ${ date }` );

              // Extract team name from final release event description.
              if ( eventKey === 'final' && matchingEvent && matchingEvent.description ) {
                const teamMatch = matchingEvent.description.match( /Team:\s*(.+)/i );
                if ( teamMatch && teamMatch[ 1 ] ) {
                  teamName = teamMatch[ 1 ].trim().toLowerCase().replace( /\s+/g, '-' );
                  console.log( `Team name from the event description: ${ teamName }` );
                }
              }
            }

            if ( ! teamName ) {
              core.setFailed( 'Team name not found in final release event description. Expected "Team: <name>" in event description.' );
              return;
            }
            core.setOutput( 'team-name', teamName );

  trigger-upcoming-code-freeze-events:
    name: Assign a release lead
    needs: [check-upcoming-release-events]
    if: ${{ needs.check-upcoming-release-events.outputs.should-trigger-webhook == 'true' }}
    runs-on: ${{ ( github.repository == 'woocommerce/woocommerce' && 'blacksmith-2vcpu-ubuntu-2404' ) || 'ubuntu-latest' }}
    outputs:
      create-tracking-issues: ${{ steps.trigger-upcoming-code-freeze-events.outputs.create-tracking-issues }}
      post: ${{ steps.trigger-upcoming-code-freeze-events.outputs.post }}
      release-team: ${{ steps.trigger-upcoming-code-freeze-events.outputs.release-team }}
      release-lead: ${{ steps.trigger-upcoming-code-freeze-events.outputs.release-lead }}
      release-lead-google-login: ${{ steps.trigger-upcoming-code-freeze-events.outputs.release-lead-google-login }}
      release-lead-slack-member-id: ${{ steps.trigger-upcoming-code-freeze-events.outputs.release-lead-slack-member-id }}
    steps:
      - uses: actions/github-script@v7
        id: trigger-upcoming-code-freeze-events
        with:
          script: |
            const crypto = require( 'crypto' );

            const payload = {
              action: 'release-assignment',
              team: '${{ needs.check-upcoming-release-events.outputs.team-name }}',
              version: '${{ needs.check-upcoming-release-events.outputs.version }}',
              feature_freeze_date: '${{ needs.check-upcoming-release-events.outputs.feature-freeze-date }}',
              status: process.env.ENVIRONMENT === 'production' ? 'publish' : 'draft'
            };

            const requestBody = JSON.stringify( {
              payload
            } );

            const hmac = crypto.createHmac( 'sha256', process.env.WPCOM_WEBHOOK_SECRET );
            hmac.update( requestBody );
            const signature = hmac.digest( 'hex' );

            const response = await fetch( process.env.WPCOM_RELEASE_WEBHOOK_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Hub-Signature-256': `sha256=${ signature }`
              },
              body: requestBody
            } );

            if ( ! response.ok ) {
              const status = response.status;
              let errorMessage = `Request failed with status ${ status }`;

              switch ( status ) {
                case 409:
                  errorMessage = `Post already exists for this release (${ status })`;
                  console.log( errorMessage );
                  break;
                case 403:
                  errorMessage = `Invalid webhook secret or unauthorized access (${ status })`;
                  core.setFailed( errorMessage );
                  break;
                default:
                  core.setFailed( errorMessage );
                  break;
              }
            } else {
              console.log( 'Successfully triggered upcoming release notification webhook' );

              const responseBody = await response.json();
              core.setOutput( 'create-tracking-issues', 'true' );

              core.setOutput( 'release-team', responseBody.data.release_team );
              core.setOutput( 'release-lead', responseBody.data.release_lead );
              core.setOutput( 'release-lead-google-login', responseBody.data.release_lead_google_login );
              core.setOutput( 'release-lead-slack-member-id', responseBody.data.release_lead_slack_member_id );
              core.setOutput( 'post', responseBody.data.post.view_url );
            }
        env:
          ENVIRONMENT: ${{ secrets.ENVIRONMENT }}
          WPCOM_WEBHOOK_SECRET: ${{ secrets.WPCOM_WEBHOOK_SECRET }}
          WPCOM_RELEASE_WEBHOOK_URL: ${{ secrets.WPCOM_RELEASE_WEBHOOK_URL }}

  send-slack-notification:
    name: Send Slack notification
    needs: [trigger-upcoming-code-freeze-events, check-upcoming-release-events, create-parent-tracking-issue, create-sub-tracking-issues]
    if: ${{ needs.trigger-upcoming-code-freeze-events.outputs.create-tracking-issues == 'true' }}
    runs-on: ${{ ( github.repository == 'woocommerce/woocommerce' && 'blacksmith-2vcpu-ubuntu-2404' ) || 'ubuntu-latest' }}
    steps:
      - name: Send Slack notification
        uses: archive/github-actions-slack@a62d71a4ea93e68cbdc37581166b0298bea512e9 # v2.10.0
        with:
          slack-bot-user-oauth-access-token: ${{ secrets.CODE_FREEZE_BOT_TOKEN }}
          slack-channel: ${{ secrets.WOO_RELEASE_SLACK_CHANNEL }}
          slack-optional-unfurl_links: false
          slack-text: |
            :woo: *The WooCommerce ${{ needs.check-upcoming-release-events.outputs.version }} release is coming up!* :woo:

            The team responsible for this release is *Team ${{ needs.check-upcoming-release-events.outputs.team-name }}*.
            <@${{ needs.trigger-upcoming-code-freeze-events.outputs.release-lead-slack-member-id }}>, make sure you choose a release DRI and update the release P2 accordingly.

            :p2: <${{ needs.trigger-upcoming-code-freeze-events.outputs.post }}|Release P2 post> | :linear-logo: <${{ needs.create-parent-tracking-issue.outputs.issue-url }}|Linear tracking issue>

  create-parent-tracking-issue:
    name: Create Parent Tracking Issue in Linear
    needs: [trigger-upcoming-code-freeze-events, check-upcoming-release-events]
    if: ${{ needs.trigger-upcoming-code-freeze-events.outputs.create-tracking-issues == 'true' }}
    runs-on: ${{ ( github.repository == 'woocommerce/woocommerce' && 'blacksmith-2vcpu-ubuntu-2404' ) || 'ubuntu-latest' }}
    outputs:
      sub-issues-matrix: ${{ steps.build-matrix.outputs.matrix }}
      issue-url: ${{ steps.check-existing-issue.outputs.issue-url || steps.create-tracking-issue.outputs.issue-url }}
    steps:
      - name: Checkout repository (sparse)
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .linear
          sparse-checkout-cone-mode: false

      - name: Install linear-sdk
        run: npm install @linear/sdk@71.0.0

      - name: Check for existing release tracking issue
        id: check-existing-issue
        uses: actions/github-script@v7
        with:
          script: |
            const { LinearClient } = require( '@linear/sdk' );
            const linearClient = new LinearClient( {
              apiKey: '${{ secrets.LINEAR_OAUTH_TOKEN }}'
            } );

            const releaseMainVersion = '${{ needs.check-upcoming-release-events.outputs.version }}';
            const expectedTitle = `[${ releaseMainVersion }] Release tracking`;

            console.log( `Checking for existing issue with title: "${ expectedTitle }"` );

            const issues = await linearClient.issues( {
              filter: {
                team: { id: { eq: '${{ secrets.LINEAR_TEAM_ID }}' } },
                title: { eq: expectedTitle }
              }
            } );

            if ( issues.nodes.length > 0 ) {
              console.log( 'Found existing release tracking issue' );
              core.setOutput( 'exists', 'true' );
              core.setOutput( 'issue-url', issues.nodes[ 0 ].url );
            } else {
              console.log( 'No existing release tracking issue found' );
              core.setOutput( 'exists', 'false' );
            }

      - name: Get Linear data
        if: ${{ steps.check-existing-issue.outputs.exists != 'true' }}
        id: get-linear-data
        uses: actions/github-script@v7
        with:
          script: |
            const { LinearClient } = require( '@linear/sdk' );
            const linearClient = new LinearClient( {
              apiKey: '${{ secrets.LINEAR_OAUTH_TOKEN }}'
            } );

            const organization = await linearClient.organization;

            const labels = await linearClient.issueLabels( {
              filter: {
                name: { eq: 'Release' }
              }
            } );

            const states = await linearClient.workflowStates( {
              filter: {
                team: { id: { eq: '${{ secrets.LINEAR_TEAM_ID }}' } },
                name: { eq: 'In Progress' }
              }
            } );

            const releaseLabelId = labels.nodes.length > 0 ? labels.nodes[ 0 ].id : null;
            const inProgressStateId = states.nodes.length > 0 ? states.nodes[ 0 ].id : null;

            core.setOutput( 'releaseLabelId', releaseLabelId );
            core.setOutput( 'inProgressStateId', inProgressStateId );
            core.setOutput( 'organizationUrlKey', organization.urlKey );

      - name: Get Linear user from email
        if: ${{ steps.check-existing-issue.outputs.exists != 'true' }}
        id: get-linear-user
        uses: actions/github-script@v7
        with:
          script: |
            const { LinearClient } = require( '@linear/sdk' );
            const linearClient = new LinearClient( {
              apiKey: '${{ secrets.LINEAR_OAUTH_TOKEN }}'
            } );

            const email = '${{ needs.trigger-upcoming-code-freeze-events.outputs.release-lead-google-login }}';
            const users = await linearClient.users( {
              filter: {
                email: { eq: email }
              }
            } );

            const userId = users.nodes.length ? users.nodes[ 0 ].id : null;
            const displayName = users.nodes.length ? users.nodes[ 0 ].displayName : null;
            const username = users.nodes.length ? users.nodes[ 0 ].username : null;

            console.log( userId ? 'Found Linear user for assignee' : 'No Linear user found for assignee' );

            core.setOutput( 'assignee-id', userId || '' );
            core.setOutput( 'assignee-display-name', displayName || '' );
            core.setOutput( 'assignee-username', username || '' );

      - name: Process template and create release tracking issue
        if: ${{ steps.check-existing-issue.outputs.exists != 'true' }}
        id: create-tracking-issue
        uses: actions/github-script@v7
        with:
          script: |
            const { LinearClient } = require( '@linear/sdk' );
            const fs = require( 'fs' );

            const linearClient = new LinearClient( {
              apiKey: '${{ secrets.LINEAR_OAUTH_TOKEN }}'
            } );

            // Read template file.
            const templatePath = '.linear/release-kickoff.md';
            let templateContent;

            try {
              templateContent = fs.readFileSync( templatePath, 'utf8' );
            } catch ( error ) {
              core.setFailed( `Failed to read template file: ${ error.message }` );
              return;
            }

            // Parse template (first line is title with # prefix).
            const lines = templateContent.split( '\n' );
            const titleTemplate = lines[ 0 ].slice( 2 ).trim();
            const bodyTemplate = lines.slice( 1 ).join( '\n' ).trim();

            // Prepare placeholder values.
            const username = '${{ steps.get-linear-user.outputs.assignee-username }}';
            const organizationUrlKey = '${{ steps.get-linear-data.outputs.organizationUrlKey }}';
            const mention = username ? `https://linear.app/${ organizationUrlKey }/profiles/${ username }` : null;

            const releaseMainVersion = '${{ needs.check-upcoming-release-events.outputs.version }}';
            const releaseMilestone = `${ releaseMainVersion }.0`;
            const releaseBranch = `release/${ releaseMainVersion }`;

            const featureFreezeDate = '${{ needs.check-upcoming-release-events.outputs.feature-freeze-date }}';

            const repositoryUrl = `https://github.com/${ context.repo.owner }/${ context.repo.repo }`;
            const replacements = {
              '{repository_url}': repositoryUrl,
              '{release_main_version}': releaseMainVersion,
              '{release_milestone}': releaseMilestone,
              '{release_branch}': releaseBranch,
              '{release_version}': releaseMilestone,
              '{release_date}': '',
              '{release_type}': '',
              '{release_monitoring_time}': '',
              '{lead_user}': mention || '${{ needs.trigger-upcoming-code-freeze-events.outputs.release-lead }}',
              '{lead_team}': '${{ needs.trigger-upcoming-code-freeze-events.outputs.release-team }}',
              '{date_feature_freeze}': featureFreezeDate ? featureFreezeDate.split( 'T' )[ 0 ] : '',
              '{date_beta1}': '${{ needs.check-upcoming-release-events.outputs.beta-1-release-date }}',
              '{date_beta2}': '${{ needs.check-upcoming-release-events.outputs.beta-2-release-date }}',
              '{date_rc1}': '${{ needs.check-upcoming-release-events.outputs.rc-1-release-date }}',
              '{date_stable}': '${{ needs.check-upcoming-release-events.outputs.final-release-date }}'
            };

            // Apply replacements.
            let title = titleTemplate;
            let body = bodyTemplate;

            for ( const [ placeholder, value ] of Object.entries( replacements ) ) {
              title = title.replaceAll( placeholder, value );
              body = body.replaceAll( placeholder, value );
            }

            // Create the Linear issue.
            const labelId = '${{ steps.get-linear-data.outputs.releaseLabelId }}' || null;
            const stateId = '${{ steps.get-linear-data.outputs.inProgressStateId }}' || null;
            const assigneeId = '${{ steps.get-linear-user.outputs.assignee-id }}' || null;

            try {
              const parentResult = await linearClient.createIssue( {
                teamId: '${{ secrets.LINEAR_TEAM_ID }}',
                title: title,
                description: body,
                priority: 2,
                ...( labelId && { labelIds: [ labelId ] } ),
                ...( stateId && { stateId } ),
                ...( assigneeId && { assigneeId } )
              } );

              const parentIssue = await parentResult.issue;
              console.log( 'Parent tracking issue created successfully' );
              core.setOutput( 'issue-url', parentIssue.url );
            } catch ( error ) {
              core.setFailed( `Failed to create parent Linear issue: ${ error.message }` );
            }

      - name: Build sub-issues matrix
        id: build-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ needs.check-upcoming-release-events.outputs.version }}';

            const matrix = {
              include: [
                { version: `${ version }.0-beta.1`, releaseDate: '${{ needs.check-upcoming-release-events.outputs.beta-1-release-date }}' },
                { version: `${ version }.0-beta.2`, releaseDate: '${{ needs.check-upcoming-release-events.outputs.beta-2-release-date }}' },
                { version: `${ version }.0-rc.1`,   releaseDate: '${{ needs.check-upcoming-release-events.outputs.rc-1-release-date }}' },
                { version: `${ version }.0`,        releaseDate: '${{ needs.check-upcoming-release-events.outputs.final-release-date }}' }
              ]
            };

            core.setOutput( 'matrix', JSON.stringify( matrix ) );

  create-sub-tracking-issues:
    name: Create sub-issue for tracking ${{ matrix.version }} release
    needs: [create-parent-tracking-issue]
    strategy:
      matrix: ${{ fromJSON(needs.create-parent-tracking-issue.outputs.sub-issues-matrix) }}
    uses: ./.github/workflows/release-create-tracking-issue.yml
    with:
      version: ${{ matrix.version }}
      release-date: ${{ matrix.releaseDate }}
      skip-branch-validation: true
    secrets:
      LINEAR_OAUTH_TOKEN: ${{ secrets.LINEAR_OAUTH_TOKEN }}
      LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}

  notify-on-failure:
    name: Notify on failure
    needs: [check-upcoming-release-events, trigger-upcoming-code-freeze-events, send-slack-notification, create-parent-tracking-issue, create-sub-tracking-issues]
    if: ${{ failure() }}
    runs-on: ${{ ( github.repository == 'woocommerce/woocommerce' && 'blacksmith-2vcpu-ubuntu-2404' ) || 'ubuntu-latest' }}
    steps:
      - name: Send failure notification to Slack
        uses: archive/github-actions-slack@a62d71a4ea93e68cbdc37581166b0298bea512e9 # v2.10.0
        with:
          slack-bot-user-oauth-access-token: ${{ secrets.CODE_FREEZE_BOT_TOKEN }}
          slack-channel: ${{ secrets.WOO_RELEASE_SLACK_CHANNEL }}
          slack-optional-unfurl_links: false
          slack-text: |
            :x: Some steps in the Release Assignment workflow failed. Please check the logs for details and re-run if needed.
            <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View workflow run>
