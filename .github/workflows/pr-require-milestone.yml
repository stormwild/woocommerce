name: 'Require milestone on pull requests'

on:
  pull_request:
    types:
      - opened
      - reopened
      - edited
      - synchronize
      - ready_for_review
      - milestoned
      - demilestoned
    branches:
        - trunk

permissions:
  pull-requests: read

jobs:
  ensure-milestone:
    name: 'Ensure milestone is assigned'
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: 'Validate milestone'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
            });

            if (!issue.milestone) {
                core.setFailed('Assign a milestone before merging this pull request.');
                return;
            }

            core.info(`Milestone "${issue.milestone.title}" is set.`);