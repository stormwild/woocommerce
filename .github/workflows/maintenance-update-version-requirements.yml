name: 'Maintenance: Update version requirements'

on:
  schedule:
    - cron: '0 0 * * *' # Runs every day at midnight UTC
  workflow_dispatch:

jobs:
  preparation:
    name: Check versions and prep for update
    runs-on: ubuntu-latest
    outputs:
      current_wp_version: ${{ steps.compute-wp-versions.outputs.wp_version }}
      required_wp_version: ${{ steps.compute-wp-versions.outputs.wp_required_version }}
      matrix: ${{ steps.compute-branches.outputs.matrix }}
    steps:
      - name: Check out trunk
        uses: actions/checkout@v4
        with:
          ref: trunk
      - name: Compute WordPress versions
        id: compute-wp-versions
        run: |
          # Fetch latest WP version.
          wp_version=$(curl -s https://api.wordpress.org/core/version-check/1.7/ | jq -r '.offers[0].current' | sed -E 's/^([0-9]+\.[0-9]+).*/\1/' )
          if [[ -z "$wp_version" ]]; then
            echo "Failed to get WordPress version"
            exit 1
          fi

          echo "wp_version=$wp_version" >> $GITHUB_OUTPUT
          echo "Latest WordPress version is $wp_version."

          # Calculate L-1 version.
          wp_required_version=$(echo "$wp_version - 0.1" | bc)
          echo "wp_required_version=$wp_required_version" >> $GITHUB_OUTPUT
          echo "L-1 WordPress version is $wp_required_version."
      - name: Compute target branches
        id: compute-branches
        run: |
          # Fetch all branches from origin.
          git fetch origin

          # Main version on trunk (e.g. '10.4')
          trunk_main_version=$( git show origin/trunk:plugins/woocommerce/woocommerce.php | grep -oP '(?<=Version: )(.+)' | head -n1 | sed -E 's/^([0-9]+\.[0-9]+).*/\1/' )

          # If release/<trunk_main_version> exists, we might be on a feature freeze day and just haven't merged the bump version PR yet.
          if git ls-remote --exit-code --heads origin "release/$trunk_main_version" >/dev/null 2>&1; then
            trunk_main_version=$(echo "$trunk_main_version + 0.1" | bc)
          fi

          # Frozen main version (e.g. '10.3').
          frozen_main_version=$(echo "$trunk_main_version - 0.1" | bc)

          # Check version on frozen release branch to see if it's out or not.
          include_frozen_release="no"
          frozen_release_branch="release/$frozen_main_version"
          frozen_version=""

          if git ls-remote --exit-code --heads origin "$frozen_release_branch" >/dev/null 2>&1; then
            frozen_version=$( git show origin/$frozen_release_branch:plugins/woocommerce/woocommerce.php | grep -oP '(?<=Version: )(.+)' | head -n1 )
          fi

          if [[ -n "$frozen_version" ]] && php -r "exit( version_compare( '$frozen_version', '$frozen_main_version.0-rc.1', '<' ) ? 0 : 1 );"; then
            include_frozen_release="yes"
          fi

          # Build the matrix.
          matrix=$(jq -n '{ include: [] }')

          if [[ "$include_frozen_release" == "yes" ]]; then
            matrix=$(jq -n --arg frozen_main_version "$frozen_main_version" '
              {
                include: [
                  { branch: ("release/" + $frozen_main_version), milestone: ($frozen_main_version + ".0"), skip_wp_version_changelog: "no" },
                  { branch: "trunk", milestone: ($frozen_main_version + ".0"), skip_wp_version_changelog: "yes" }
                ]
              }
            ')
          else
            matrix=$(jq -n --arg trunk_main_version "$trunk_main_version" '
              {
                include: [
                  { branch: "trunk", milestone: ($trunk_main_version + ".0"), skip_wp_version_changelog: "no" }
                ]
              }
            ')
          fi

          {
            echo "matrix<<EOF"
            echo "$matrix"
            echo "EOF"
          } >> $GITHUB_OUTPUT

  update-versions:
    needs: [preparation]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.preparation.outputs.matrix) }}
    steps:
      - name: Check out branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}
      - name: Set up dev environment
        run: |
          # Configure Git.
          git config --global user.name "woocommercebot"
          git config --global user.email "woocommercebot@users.noreply.github.com"

          # Configure token for Composer.
          composer config --global github-oauth.github.com "${{ secrets.GITHUB_TOKEN }}"

          cd plugins/woocommerce

          # Install dev packages. Required for changelogger use.
          composer install --quiet
      - name: Update version requirements
        id: update-versions
        env:
          WP_VERSION: ${{ needs.preparation.outputs.current_wp_version }}
          WP_REQUIRED_VERSION: ${{ needs.preparation.outputs.required_wp_version }}
          GH_TOKEN: ${{ secrets.WC_BOT_PR_CREATE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          current_branch="${{ matrix.branch }}"

          git fetch origin

          # Branch name hardcoded to avoid conflicts.
          branch_name="update-wp-php-requirements-on-${current_branch#release/}"

          # Delete local branch if it exists and create fresh from branch.
          git branch -D "$branch_name" 2>/dev/null || true
          git checkout -b "$branch_name" "origin/${current_branch}"

          # Change to woocommerce dir.
          cd plugins/woocommerce

          # Handle PHP version update.
          required_php_version=$(jq -r '.config.platform.php' composer.json)
          if [[ -z "$required_php_version" ]]; then
            echo "Failed to get PHP version from composer.json"
            exit 1
          fi

          echo "Required PHP version from composer.json: $required_php_version"

          # Update PHP version requirements.
          sed -i "s/\* Requires PHP: [0-9.]*/\* Requires PHP: $required_php_version/" "woocommerce.php"
          sed -i "s/Requires PHP: [0-9.]*/Requires PHP: $required_php_version/" "readme.txt"
          sed -i "s/PHP [0-9.]\+ or greater is required/PHP $required_php_version or greater is required/" "readme.txt"

          # If this resulted in changes, create a commit and changelog entry for the PHP version update.
          if ! git diff --quiet; then
            rm -f "changelog/${branch_name}-php"
            composer exec -- changelogger add \
              --significance minor \
              --type update \
              --entry "Update PHP version requirement to $required_php_version." \
              --filename "${branch_name}-php" \
              --no-interaction

            git add .
            git commit -m "Update PHP version requirement to $required_php_version"
          fi

          # Update WordPress version requirements.
          sed -i "s/\* Requires at least: [0-9.]*/\* Requires at least: $WP_REQUIRED_VERSION/" "woocommerce.php"
          sed -i "s/Requires at least: [0-9.]*/Requires at least: $WP_REQUIRED_VERSION/" "readme.txt"
          sed -i "s/Tested up to: [0-9.]*/Tested up to: $WP_VERSION/" "readme.txt"
          sed -i "s/WordPress [0-9.]\+/WordPress $WP_REQUIRED_VERSION/" "readme.txt"

          # Check for changes and exit early if none.
          if git diff --quiet; then
            echo "No changes detected. No PR needed."
            exit 0
          fi

          # Add changelog entry.
          rm -f "changelog/${branch_name}-wp"

          skip_changelog=""
          if [[ "${{ matrix.skip_wp_version_changelog }}" == "yes" ]]; then
            skip_changelog="<!-- [x] This Pull Request does not require a changelog -->"
          else
            composer exec -- changelogger add \
              --significance minor \
              --type update \
              --entry "Update version requirements to WordPress $WP_REQUIRED_VERSION." \
              --filename "${branch_name}-wp" \
              --no-interaction
          fi

          # Commit changes.
          git add .
          git commit -m "Update version requirements to WP $WP_REQUIRED_VERSION"

          # Push only if remote branch doesn't exist or differs from our changes.
          if ! git ls-remote --exit-code --heads origin "$branch_name" >/dev/null 2>&1 || ! git diff --quiet HEAD origin/"$branch_name"; then
            echo "Pushing changes to remote branch."
            git push --force origin "$branch_name"
          else
            echo "No changes compared to remote branch. Skipping push."
          fi

          # Prepare PR content.
          pr_title="Update WP/PHP version requirements on \`$current_branch\`"
          pr_body="This PR automatically updates the version requirements in \`woocommerce.php\` and \`readme.txt\`:

          ## Changes
          - **WordPress requirement**: $WP_REQUIRED_VERSION
          - **PHP requirement**: $required_php_version
          - **Tested up to**: $WP_VERSION

          ### ⚠️ Before merging

          Ensure that:

          - [ ] **WordPress $WP_VERSION compatibility** has been tested and verified.
          - [ ] **PHP $required_php_version compatibility** has been tested and verified.

          ## ⚠️ After merging

          Please check with the Woo Docs team in \`#woo-docs\` to ensure the following documentation pages are updated:

          - [ ] [Update PHP and WordPress](https://woocommerce.com/document/update-php-wordpress/)
          - [ ] [WooCommerce Server Requirements](https://woocommerce.com/document/server-requirements/)

          ---
          _Auto-generated by the \`maintenance-update-version-requirements.yml\` workflow._

          $skip_changelog
          "

          # Check if PR already exists.
          pr_number_or_url=$(gh pr list --head "$branch_name" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [[ -n "$pr_number_or_url" ]]; then
            echo "PR #$pr_number_or_url already exists. Updating title and body."
            gh pr edit "$pr_number_or_url" \
              --title "$pr_title" \
              --body "$pr_body"
          else
            echo "Creating new PR."
            pr_number_or_url=$(gh pr create \
              --title "$pr_title" \
              --body "$pr_body" \
              --head "$branch_name" \
              --base "$current_branch" \
              --label "Release")
          fi

          # Set milestone.
          gh pr edit "$pr_number_or_url" --milestone "${{ matrix.milestone }}"
